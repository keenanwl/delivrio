<div class="container" *ngIf="orders$|async; let orders">
	<div class="inset-container">
		<div class="header-row">
			<h3>Orders</h3>
			<span class="spacer"></span>
			<div class="filter-form">
				<button class="filter-icon" matSuffix mat-icon-button aria-label="Filter" >
					<mat-icon>filter_list</mat-icon>
				</button>
				<mat-chip-row (click)="chipClickSelect(where.value.name)"
						  [highlighted]="where.key === orders.selectedWhere.name"
						  *ngFor="let where of orders.selectedWheres | keyvalue">

					{{where.value.name}}: {{where.value.selectedOption?.name}}
					<button matChipRemove (click)="removeChip(where.key)">
						<mat-icon>cancel</mat-icon>
					</button>
				</mat-chip-row>
				&nbsp;
				<input class="field"
					   type="text"
					   #autoInput
					   (keydown.enter)="toChip()"
					   [matAutocomplete]="auto"
					   [formControl]="filterControl"
					   [placeholder]="'Type to filter'">

					<mat-autocomplete #auto="matAutocomplete" (optionSelected)="dropDownSelected(orders.selectedWhere.name, $event.option.value)">
						@for (where of orders.localFilteredWhere; track where) {
							<mat-option [value]="where">
								<mat-icon>{{where.icon}}</mat-icon>
								{{where.name}}
							</mat-option>
						}
					</mat-autocomplete>

				<button (click)="removeAllChips()" matSuffix mat-icon-button aria-label="Clear" [disabled]="orders.selectedWheres.size === 0">
					<mat-icon>close</mat-icon>
				</button>
			</div>
			<button mat-icon-button [matMenuTriggerFor]="menu">
				<mat-icon>more_vert</mat-icon>
			</button>
			<mat-menu #menu="matMenu">
				<button mat-menu-item (click)="newOrder()">
					<mat-icon>add</mat-icon>
					New order
				</button>
				<button mat-menu-item (click)="selectColumns()">
					<mat-icon>view_column_2</mat-icon>
					Show/hide columns
				</button>
				<button mat-menu-item [disabled]="disableBulk(orders.orderRowsSelected)" (click)="selectPackaging()">
					<mat-icon>box</mat-icon>
					<span>Bulk({{Object.keys(orders.orderRowsSelected).length}}): Add packaging</span>
				</button>
				<button mat-menu-item [disabled]="disableBulk(orders.orderRowsSelected)" (click)="bulkFetchPackingSlips()">
					<mat-icon>warehouse</mat-icon>
					<span>Bulk({{Object.keys(orders.orderRowsSelected).length}}): Packing slip</span>
				</button>
			</mat-menu>
		</div>
		<div class="progress-bar">
			<mat-progress-bar *ngIf="orders.loading" mode="indeterminate"></mat-progress-bar>
		</div>
		<table mat-table
			   matSort matSortActive="creation" matSortDisableClear [matSortDirection]="orders.sortDirection === 'ASC' ? 'asc' : 'desc'"
			   [dataSource]="orders.orders">

			<ng-container matColumnDef="orderNumber">
				<th mat-header-cell *matHeaderCellDef [hidden]="!orders.displayedColumns.includes('orderNumber')">Order no.</th>
				<td mat-cell *matCellDef="let element" [hidden]="!orders.displayedColumns.includes('orderNumber')"> {{element.orderPublicID}} </td>
			</ng-container>

			<ng-container matColumnDef="creation">
				<th mat-header-cell mat-sort-header [hidden]="!orders.displayedColumns.includes('creation')" *matHeaderCellDef>
					Created
				</th>
				<td mat-cell *matCellDef="let element" [hidden]="!orders.displayedColumns.includes('creation')">
					{{element.createdAt | date:"mediumDate"}}
				</td>
			</ng-container>

			<ng-container matColumnDef="recipient">
				<th mat-header-cell [hidden]="!orders.displayedColumns.includes('recipient')" *matHeaderCellDef>
					Recipient
				</th>
				<td mat-cell [hidden]="!orders.displayedColumns.includes('recipient')" *matCellDef="let element">
					{{element.colli[0]?.recipient.firstName}} {{element.colli[0]?.recipient.lastName}}
				</td>
			</ng-container>


			<ng-container matColumnDef="connection">
				<th mat-header-cell *matHeaderCellDef [hidden]="!orders.displayedColumns.includes('connection')">Connection</th>
				<td mat-cell *matCellDef="let element" [hidden]="!orders.displayedColumns.includes('connection')">
					{{element.connection?.name}}
				</td>
			</ng-container>

			<ng-container matColumnDef="status">
				<th mat-header-cell *matHeaderCellDef [hidden]="!orders.displayedColumns.includes('status')">Status</th>
				<td mat-cell *matCellDef="let element" [hidden]="!orders.displayedColumns.includes('status')">
					<mat-chip-row [style.background-color]="element.status | orderStatusColorPipe" highlighted>
						{{element.status}}
					</mat-chip-row>
				</td>
			</ng-container>
			<ng-container matColumnDef="shipments">
				<th mat-header-cell *matHeaderCellDef [hidden]="!orders.displayedColumns.includes('shipments')">Shipments</th>
				<td mat-cell *matCellDef="let element" [hidden]="!orders.displayedColumns.includes('shipments')">
					<mat-chip-set>
						<ng-container *ngFor="let colli of element.colli">
							<mat-chip-row [style.background-color]="colli.shipmentParcel?.status | shipmentParcelStatusColorPipe" highlighted>
								{{colli.shipmentParcel?.status || '-'}}
							</mat-chip-row>
						</ng-container>
					</mat-chip-set>
				</td>
			</ng-container>

			<ng-container matColumnDef="total">
				<th mat-header-cell *matHeaderCellDef [hidden]="!orders.displayedColumns.includes('total')"> Total </th>
				<td mat-cell *matCellDef="let element" [hidden]="!orders.displayedColumns.includes('total')" class="total">
					{{element.colli | totalOrderValue}}
				</td>
			</ng-container>
			<ng-container matColumnDef="country">
				<th mat-header-cell *matHeaderCellDef [hidden]="!orders.displayedColumns.includes('country')"> Country </th>
				<td mat-cell *matCellDef="let element" [hidden]="!orders.displayedColumns.includes('country')">
					{{element.colli[0]?.recipient.country.alpha2}}
				</td>
			</ng-container>

			<ng-container matColumnDef="deliveryOption">
				<th mat-header-cell *matHeaderCellDef [hidden]="!orders.displayedColumns.includes('deliveryOption')"> Delivery </th>
				<td mat-cell *matCellDef="let element" [hidden]="!orders.displayedColumns.includes('deliveryOption')">
					<ng-container *ngIf="!!element.colli[0]?.deliveryOption">
						{{element.colli[0]?.deliveryOption?.carrier?.carrierBrand?.label}}: {{element.colli[0]?.deliveryOption?.name}}
					</ng-container>
				</td>
			</ng-container>

			<ng-container matColumnDef="select">
				<th mat-header-cell *matHeaderCellDef>
					<mat-checkbox (change)="$event ? masterToggle() : null"
								  color="primary"
								  [checked]="isAllSelected(orders.orderRowsSelected, orders.orders)"
								  [indeterminate]="Object.keys(orders.orderRowsSelected).length > 0 && !isAllSelected(orders.orderRowsSelected, orders.orders)">
					</mat-checkbox>

				</th>
				<td mat-cell *matCellDef="let row">
					<mat-checkbox (click)="$event.stopPropagation()"
								  color="primary"
								  (change)="$event ? toggleRow(row) : null"
								  [checked]="orders.orderRowsSelected[row.id]">
					</mat-checkbox>
				</td>
			</ng-container>

			<tr mat-header-row *matHeaderRowDef="orders.displayedColumns"></tr>
			<tr mat-row class="row-container" *matRowDef="let row; columns: displayedColumns;" (click)="edit(row.id)"></tr>
		</table>
		<mat-divider></mat-divider>
		<mat-paginator [pageIndex]="orders.pagination.pageIndex"
					   [hidePageSize]="true"
					   [pageSize]="15"
					   [length]="orders.pagination.totalResults"
					   (page)="movePage($event)">
		</mat-paginator>
	</div>
</div>
